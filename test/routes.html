<!DOCTYPE html><html lang="en"><head><title>test/routes</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="test/routes"><meta name="groc-project-path" content="test/routes.js"><meta name="groc-github-url" content="https://github.com/oslugr/polleitor"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/oslugr/polleitor/blob/master/test/routes.js">test/routes.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="test-rutas">Test - Rutas</h1>
<p>Tests sobre las rutas de Polleitor</p></div></div><div class="code"><div class="wrapper"><span class="hljs-comment">//Desarrollado por la Oficina de Software Libre bajo licencia MIT</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dependencias">Dependencias</h2>
<ul>
<li><strong>Should:</strong> Módulo de aserciones de estilo BDD</li>
<li><strong>Supertest-session:</strong> Módulo de conexiones HTTP con sesiones para tests.</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> should = <span class="hljs-built_in">require</span>(<span class="hljs-string">'should'</span>);
<span class="hljs-keyword">var</span> supertest = <span class="hljs-built_in">require</span>(<span class="hljs-string">'supertest-session'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="dependencias-locales">Dependencias locales</h3>
<ul>
<li><a href="../config.html"><strong>Config</strong></a>: Configuración general de Polleitor<ul>
<li>Modificación en <code>loki_db_name</code></li>
</ul>
</li>
<li><a href="./init.html"><strong>Test Init</strong></a>: Inicialización de servidor de prueba</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../app/config'</span>);
config.loki_db_name = <span class="hljs-string">"test.json"</span>;
<span class="hljs-keyword">var</span> testInit = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./init'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="configuracin">Configuración</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>loki_db_name: <code>test.json</code><ul>
<li>Nombre del archivo para almacenar la base de datos</li>
</ul>
</li>
<li>poll: Configuración del Poll a usar de pruebas</li>
</ul></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> poll = <span class="hljs-built_in">Object</span>.keys(config.polls)[<span class="hljs-number">0</span>]; <span class="hljs-comment">// Usa la primera encuesta</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="pruebas-de-rutas">Pruebas de Rutas</h2>
<p>Pruebas sobre las rutas del servidor</p>
<ul>
<li><em>before:</em> Inicia el servidor y base de datos</li>
<li><em>after:</em> Cierra el servidor</li>
</ul></div></div><div class="code"><div class="wrapper">describe(<span class="hljs-string">'Routes'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> app;
    <span class="hljs-keyword">var</span> dbHandler;
    <span class="hljs-keyword">var</span> request;
    before(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done</span>) </span>{
        testInit.init(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app2, handler</span>) </span>{
            should.exist(app2);
            should.exist(handler);
            app = app2;
            dbHandler = handler;
            request = supertest(app);
            done();
        });
    });
    after(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        testInit.close();
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><strong>Get poll:</strong> Comprueba la ruta <code>GET /:poll</code>, que devuelve una encuesta</li>
</ul></div></div><div class="code"><div class="wrapper">    it(<span class="hljs-string">'Get poll'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done</span>) </span>{
        request.get(<span class="hljs-string">'/'</span> + poll)
            .expect(<span class="hljs-number">200</span>)
            .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                should.not.exist(err);
                should.exist(res.body);
                <span class="hljs-keyword">var</span> body = res.body;
                body.should.be.an.Array();
                body.should.not.be.empty();
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'question'</span>);
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'options'</span>);
                body[<span class="hljs-number">0</span>].options.should.be.an.Array();
                body[<span class="hljs-number">0</span>].options.should.not.be.empty();
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'id'</span>);
                request.get(<span class="hljs-string">'/tests2foo'</span>)
                    .expect(<span class="hljs-number">404</span>)
                    .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                        should.not.exist(err);
                        done();
                    });
            });
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><strong>Get Respuestas:</strong> Comprueba la ruta <code>GET /:poll/resultados</code> que devuelve una encuesta y los resultados</li>
</ul></div></div><div class="code"><div class="wrapper">    it(<span class="hljs-string">'Get Respuestas'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done</span>) </span>{
        request.get(<span class="hljs-string">'/'</span> + poll + <span class="hljs-string">'/resultados'</span>)
            .expect(<span class="hljs-number">200</span>)
            .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                should.not.exist(err);
                should.exist(res.body);
                <span class="hljs-keyword">var</span> body = res.body;
                body.should.be.an.Array();
                body.should.not.be.empty();
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'question'</span>);
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'options'</span>);
                body[<span class="hljs-number">0</span>].options.should.be.an.Array();
                body[<span class="hljs-number">0</span>].options.should.not.be.empty();
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'id'</span>);
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'answers'</span>);
                body[<span class="hljs-number">0</span>].answers.should.be.an.Array();
                body[<span class="hljs-number">0</span>].answers.should.have.length(body[<span class="hljs-number">0</span>].options.length);
                request.get(<span class="hljs-string">'/tests2foo/resultados'</span>)
                    .expect(<span class="hljs-number">404</span>)
                    .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                        should.not.exist(err);
                        done();
                    });
            });
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><strong>Put Respuesta:</strong> Comprueba la ruta <code>PUT /:poll</code> que envía las repsuestas a un poll y comprueba que se actualizan correctamente</li>
</ul></div></div><div class="code"><div class="wrapper">    it(<span class="hljs-string">'Put Respuesta'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done</span>) </span>{
        request.get(<span class="hljs-string">'/'</span> + poll + <span class="hljs-string">'/resultados'</span>)
            .expect(<span class="hljs-number">200</span>)
            .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                should.not.exist(err);
                should.exist(res.body);
                <span class="hljs-keyword">var</span> body = res.body;
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'options'</span>);
                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'answers'</span>);
                body[<span class="hljs-number">0</span>].answers.should.be.an.Array();
                body[<span class="hljs-number">0</span>].answers.should.not.be.empty();
                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">0</span>].should.be.equal(<span class="hljs-number">0</span>);
                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">1</span>].should.be.equal(<span class="hljs-number">0</span>);
                <span class="hljs-comment">//Respondemos 1 pregunta</span>
                request.put(<span class="hljs-string">'/'</span> + poll)
                    .expect(<span class="hljs-number">200</span>)
                    .send({
                        answers: [{
                            id: body[<span class="hljs-number">0</span>].id,
                            answer: <span class="hljs-number">0</span>
                        }]
                    })
                    .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                        should.not.exist(err);
                        should.exist(res.body);
                        res.body.should.have.property(<span class="hljs-string">'updates'</span>, <span class="hljs-number">1</span>);
                        res.body.should.have.property(<span class="hljs-string">'failedUpdates'</span>, <span class="hljs-number">0</span>);
                        <span class="hljs-comment">//Comprobar actualización</span>
                        request.get(<span class="hljs-string">'/'</span> + poll + <span class="hljs-string">'/resultados'</span>)
                            .expect(<span class="hljs-number">200</span>)
                            .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                                should.not.exist(err);
                                should.exist(res.body);
                                <span class="hljs-keyword">var</span> body = res.body;
                                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'answers'</span>);
                                body[<span class="hljs-number">0</span>].answers.should.be.an.Array();
                                body[<span class="hljs-number">0</span>].answers.should.not.be.empty();
                                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">0</span>].should.be.equal(<span class="hljs-number">1</span>);
                                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">1</span>].should.be.equal(<span class="hljs-number">0</span>);
                                <span class="hljs-comment">//Respondemos misma pregunta</span>
                                request.put(<span class="hljs-string">'/'</span> + poll)
                                    .expect(<span class="hljs-number">200</span>)
                                    .send({
                                        answers: [{
                                            id: body[<span class="hljs-number">0</span>].id,
                                            answer: <span class="hljs-number">0</span>
                                        }]
                                    })
                                    .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                                        should.not.exist(err);
                                        should.exist(res.body);
                                        <span class="hljs-comment">//Error en update</span>
                                        res.body.should.have.property(<span class="hljs-string">'updates'</span>, <span class="hljs-number">0</span>);
                                        res.body.should.have.property(<span class="hljs-string">'failedUpdates'</span>, <span class="hljs-number">1</span>);
                                        <span class="hljs-comment">//Comprobar que no hay cambos en los resultados</span>
                                        request.get(<span class="hljs-string">'/'</span> + poll + <span class="hljs-string">'/resultados'</span>)
                                            .expect(<span class="hljs-number">200</span>)
                                            .end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
                                                should.not.exist(err);
                                                should.exist(res.body);
                                                <span class="hljs-keyword">var</span> body = res.body;
                                                body[<span class="hljs-number">0</span>].should.have.property(<span class="hljs-string">'answers'</span>);
                                                body[<span class="hljs-number">0</span>].answers.should.be.an.Array();
                                                body[<span class="hljs-number">0</span>].answers.should.not.be.empty();
                                                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">0</span>].should.be.equal(<span class="hljs-number">1</span>);
                                                body[<span class="hljs-number">0</span>].answers[<span class="hljs-number">1</span>].should.be.equal(<span class="hljs-number">0</span>);
                                                done();
                                            });
                                    });
                            });
                    });
            });
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li><strong>Index:</strong> Comprueba que la ruta index (/) es correcta y devuelve un html</li>
</ul></div></div><div class="code"><div class="wrapper">    it(<span class="hljs-string">'Index'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">done</span>) </span>{
        request.get(<span class="hljs-string">'/'</span>).expect(<span class="hljs-number">200</span>).expect(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html; charset=UTF-8'</span>).end(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) </span>{
            should.not.exist(err);
            should.exist(res.body);
            done();
        });
    });
});</div></div></div></div></body></html>